# Rivers World Map

Backend and generative tool for an interactive map of world rivers, their confluences and downstreams in mbtiles format. For each river, its global confluence, local confluence and downstream is calculated, making it possible to visualize them with tools such as https://maplibre.org/.

### Global confluence

Global confluence is a set of all rivers that are connected together. Each river belongs to a single global confluence. The id of the corresponding global confluence is saved to every river in .mbtiles, making it possible to highlight the river's global confluence.

### Local confluence

For each river, all its tributaries are calculated and stored.

### Downstream

For a given river, its downstream is calculated.


## Generating data

It is possible to generate a single .mbtiles file from multiple individual osm.pbf files.

### Raw data

Download raw osm.pbf files from https://download.geofabrik.de/ into a single folder.

### Creating .sqlite files

Run the `rivers.py` script with the path to the folder containing osm.pbf files. The script will create necessary .sqlite files, that contain all the relevant information.
```
$ python rivers.py <path_to_osm_pbf_folder>
```

### Creating mbtiles

Using the tilemaker tool (https://tilemaker.org/) create .mbtiles files from .sqlite files using the `./tilemaker/config.json` for configuration file and `./tilemaker/process.lua` for the process file.

```
$ tilemaker --input <path_to_osm_pbf_folder> --output <path_to_mbtiles_folder> --config <config_file> --process <process_file>
```

Set <config_file> to `./tilemaker/config.json` file and <process_file> to `./tilemaker/process.lua`.

After that you will have a folder containing .mbtiles files.

### Merging files together

To merge multiple .mbtiles together, use `tile-join` (https://github.com/mapbox/tippecanoe).

```
$ tile-join --output <output_mbtiles_file> <mbtiles_source_1> <mbtiles_source_2> ... --force --no-tile-size-limit
```

Replace <output_mbtiles_file> with your desired targeted .mbtiles file, and <mbtiles_source_n> with source .mbtiles files.

## Server

The server fetches the requested data, calculates global confluence, local confluence and downstream for the given `river_id`.
Authentication is based on TOTP. 

### Starting the server

To start the server run the following command:

```
$ python server.py <path_to_config_file>
```

### Config file

All the server configuration is saved in a config file.
This is the config file example:
```
{
    "secret": "base32totpsecret",
    "mbtiles_path": "./world.mbtiles",
    "port": 8000,
    "style_path": "./style.json",
    "dict_db_folder": "./data"
}
```
* `secret` base32 secret for generating TOTP
* `mbtiles_path` path to .mbtiles file
* `port` port for the server
* `stye_path` path to style.json file. (https://maplibre.org/maplibre-style-spec/)
* `dict_db_folder` path to .sqlite files folder generated by `rivers.py`

## Requirements

To install all the python dependencies, use the following command:
```
$ pip install -r requirements.txt
```
You may also need to install `lsqlite3` package for lua. (https://luarocks.org/modules/dougcurrie/lsqlite3)

## Limitations

Since the raw data was taken from https://www.openstreetmap.org/, some waterways might be invalid (wrongly connected). Rivers in openstreetmap are composed of multiple ways. Because of this, downstream and local confluence is not calculated for the whole river, but rather from the selected way until the river's end.